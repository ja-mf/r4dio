name: Build All Platforms

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:

# IMPORTANT: Grant write permissions for releases
permissions:
  contents: write
  actions: read

env:
  MPV_VERSION: "20260207"
  MPV_COMMIT: "git-9ccd889"
  FFMPEG_COMMIT: "git-c352a9ab0"

jobs:
  # ============================================================================
  # WINDOWS BUILD
  # ============================================================================
  build-vibra-windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          repository: BayernMuller/vibra
          ref: main
      - run: vcpkg install curl:x64-windows fftw3:x64-windows
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake"
          cmake --build build --config Release
      - uses: actions/upload-artifact@v4
        with:
          name: vibra-windows
          path: build/cli/Release/vibra.exe

  build-radio-tui-windows:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc
      - run: cargo install cargo-xwin
      - run: cargo xwin build --target x86_64-pc-windows-msvc --release
      - uses: actions/upload-artifact@v4
        with:
          name: radio-tui-windows
          path: |
            target/x86_64-pc-windows-msvc/release/radio-tui.exe
            target/x86_64-pc-windows-msvc/release/radio-daemon.exe

  package-windows:
    needs: [build-vibra-windows, build-radio-tui-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: mkdir -p dist/radio-tui-windows
      
      - uses: actions/download-artifact@v4
        with:
          name: vibra-windows
          path: dist/radio-tui-windows/
      
      - uses: actions/download-artifact@v4
        with:
          name: radio-tui-windows
          path: dist/radio-tui-windows/
      
      - name: Download MPV
        run: |
          cd dist/radio-tui-windows
          # Download MPV - try both URL formats
          wget -q "https://github.com/shinchiro/mpv-winbuild-cmake/releases/download/${{ env.MPV_VERSION }}/mpv-x86_64-${{ env.MPV_VERSION }}-${{ env.MPV_COMMIT }}.7z" -O mpv.7z || \
            wget -q "https://github.com/shinchiro/mpv-winbuild-cmake/releases/download/${{ env.MPV_VERSION }}/mpv-x86_64-${{ env.MPV_COMMIT }}-${{ env.MPV_VERSION }}.7z" -O mpv.7z
          7z x mpv.7z -y && rm mpv.7z
          # Move files from subdirectory if present
          if ls -d mpv-x86_64*/ 1> /dev/null 2>&1; then
            mv mpv-x86_64*/* . && rm -rf mpv-x86_64*/
          fi
      
      - run: |
          cp songs.vds.template dist/radio-tui-windows/songs.vds
          cp stations.toml dist/radio-tui-windows/
      
      - run: |
          cat > dist/radio-tui-windows/config.toml << 'EOF'
          # Radio TUI Configuration (Windows Portable)
          [daemon]
          [http]
          enabled = true
          bind_address = "127.0.0.1"
          port = 8989
          [mpv]
          default_volume = 0.5
          [stations]
          stations_toml = "stations.toml"
          m3u_url = "https://raw.githubusercontent.com/ja-mf/radio-curation/refs/heads/main/jamf_radios.m3u"
          EOF
      
      - run: |
          cat > dist/radio-tui-windows/README.txt << 'EOF'
          Radio TUI for Windows
          =======================
          
          A terminal-based internet radio player.
          
          USAGE
          -----
          1. Run radio.exe
          2. Navigate with arrow keys
          3. Enter to play, Space to pause
          4. Press 'r' to recognize songs
          5. Press 'q' to quit
          
          FILES
          -----
          - radio.exe, radio-daemon.exe, mpv.exe, vibra.exe
          - stations.toml, config.toml, songs.vds
          
          REQUIREMENTS
          ------------
          - Windows 10/11
          - No installation required
          EOF
      
      - run: |
          cat > dist/radio-tui-windows/radio.bat << 'EOF'
          @echo off
          cd /d "%~dp0"
          "%~dp0radio.exe"
          EOF
      
      - run: cd dist && zip -r radio-tui-windows.zip radio-tui-windows/
      
      - uses: actions/upload-artifact@v4
        with:
          name: radio-tui-windows-complete
          path: dist/radio-tui-windows.zip

  # ============================================================================
  # LINUX BUILD
  # ============================================================================
  build-radio-tui-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo build --release
      - uses: actions/upload-artifact@v4
        with:
          name: radio-tui-linux
          path: |
            target/release/radio-tui
            target/release/radio-daemon

  package-linux:
    needs: [build-radio-tui-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: mkdir -p dist/radio-tui-linux
      
      - uses: actions/download-artifact@v4
        with:
          name: radio-tui-linux
          path: dist/radio-tui-linux/
      
      - run: |
          chmod +x dist/radio-tui-linux/radio-tui
          chmod +x dist/radio-tui-linux/radio-daemon
          cp songs.vds.template dist/radio-tui-linux/songs.vds
          cp stations.toml dist/radio-tui-linux/
      
      - run: |
          cat > dist/radio-tui-linux/README.md << 'EOF'
          # Radio TUI for Linux
          
          A terminal-based internet radio player.
          
          ## Installation
          
          1. Extract the archive
          2. Ensure MPV is installed: `sudo apt install mpv` (or your package manager)
          3. Run: `./radio-tui`
          
          ## Usage
          
          - Navigate with arrow keys
          - Enter to play, Space to pause
          - 'r' to recognize songs (requires vibra - build separately)
          - 'q' to quit
          
          ## Requirements
          
          - Linux with terminal
          - MPV installed system-wide
          - Optional: Vibra for song recognition (https://github.com/BayernMuller/vibra)
          EOF
      
      - run: |
          cat > dist/radio-tui-linux/install.sh << 'EOF'
          #!/bin/bash
          # Install radio-tui to /usr/local/bin
          
          set -e
          
          echo "Installing Radio TUI..."
          sudo cp radio-tui radio-daemon /usr/local/bin/
          echo "Creating config directory..."
          mkdir -p ~/.config/radio
          cp stations.toml ~/.config/radio/ 2>/dev/null || true
          echo "Done! Run: radio-tui"
          EOF
          chmod +x dist/radio-tui-linux/install.sh
      
      - run: cd dist && tar czf radio-tui-linux.tar.gz radio-tui-linux/
      
      - uses: actions/upload-artifact@v4
        with:
          name: radio-tui-linux-complete
          path: dist/radio-tui-linux.tar.gz

  # ============================================================================
  # MACOS INTEL BUILD (x86_64)
  # ============================================================================
  build-vibra-macos-intel:
    runs-on: macos-14  # Intel runner
    steps:
      - uses: actions/checkout@v4
        with:
          repository: BayernMuller/vibra
          ref: main
      
      - name: Install dependencies
        run: brew install cmake fftw pkg-config
      
      - name: Build vibra for Intel
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64
          cmake --build build --config Release
      
      - uses: actions/upload-artifact@v4
        with:
          name: vibra-macos-intel
          path: build/cli/vibra

  build-radio-tui-macos-intel:
    runs-on: macos-14  # Intel runner
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: |
          rustup target add x86_64-apple-darwin
          cargo build --release --target x86_64-apple-darwin
      - uses: actions/upload-artifact@v4
        with:
          name: radio-tui-macos-intel
          path: |
            target/x86_64-apple-darwin/release/radio-tui
            target/x86_64-apple-darwin/release/radio-daemon

  package-macos-intel:
    needs: [build-radio-tui-macos-intel]
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - run: mkdir -p dist/Radio\ TUI.app/Contents/MacOS dist/artifacts
      
      # Note: Vibra for Intel is not included (cross-compilation issues with FFTW)
      # Users can install vibra separately if needed
      
      - uses: actions/download-artifact@v4
        with:
          name: radio-tui-macos-intel
          path: dist/artifacts/radio/
      
      - name: Setup app bundle
        run: |
          # Find and move binaries (artifacts preserve directory structure)
          find dist/artifacts -name "radio-tui" -type f -exec cp {} dist/Radio\ TUI.app/Contents/MacOS/ \;
          find dist/artifacts -name "radio-daemon" -type f -exec cp {} dist/Radio\ TUI.app/Contents/MacOS/ \;
          
          # Make binaries executable
          chmod +x dist/Radio\ TUI.app/Contents/MacOS/*
          
          # Copy config files
          cp songs.vds.template dist/Radio\ TUI.app/Contents/MacOS/songs.vds
          cp stations.toml dist/Radio\ TUI.app/Contents/MacOS/
          
          # Create Info.plist
          cat > dist/Radio\ TUI.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>Radio TUI</string>
              <key>CFBundleDisplayName</key>
              <string>Radio TUI</string>
              <key>CFBundleIdentifier</key>
              <string>com.jamf.radio-tui</string>
              <key>CFBundleVersion</key>
              <string>1.0</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleExecutable</key>
              <string>launcher</string>
              <key>LSUIElement</key>
              <false/>
          </dict>
          </plist>
          EOF
          
          # Create FIXED launcher script (no escaped quotes!)
          cat > dist/Radio\ TUI.app/Contents/MacOS/launcher << 'SCRIPT'
          #!/bin/bash
          # Launcher script that opens Terminal and runs radio-tui
          
          # Get the directory where this script is located
          APP_DIR="$(cd "$(dirname "$0")" && pwd)"
          
          # Open Terminal and run radio-tui
          osascript << APPLESCRIPT
          tell application "Terminal"
              activate
              do script "cd '$APP_DIR' && ./radio-tui; exit"
          end tell
          APPLESCRIPT
          SCRIPT
          chmod +x dist/Radio\ TUI.app/Contents/MacOS/launcher
          
          # Create config.toml
          cat > dist/Radio\ TUI.app/Contents/MacOS/config.toml << 'EOF'
          # Radio TUI Configuration (macOS)
          [daemon]
          [http]
          enabled = true
          bind_address = "127.0.0.1"
          port = 8989
          [mpv]
          default_volume = 0.5
          [stations]
          stations_toml = "stations.toml"
          m3u_url = "https://raw.githubusercontent.com/ja-mf/radio-curation/refs/heads/main/jamf_radios.m3u"
          EOF
      
      - name: Create DMG with Applications shortcut
        run: |
          # Create a temporary directory for DMG contents
          mkdir -p dist/dmg-contents
          
          # Copy the app
          cp -r dist/Radio\ TUI.app dist/dmg-contents/
          
          # Create Applications folder alias
          ln -s /Applications dist/dmg-contents/Applications
          
          # Create README
          cat > dist/dmg-contents/README.txt << 'EOF'
          Radio TUI for macOS (Intel)
          ============================
          
          INSTALLATION
          ------------
          Drag Radio TUI.app to the Applications folder
          
          USAGE
          -----
          1. Double-click Radio TUI.app (opens in Terminal)
          2. Navigate with arrow keys
          3. Enter to play, Space to pause
          4. 'r' to recognize songs
          5. 'q' to quit
          
          REQUIREMENTS
          ------------
          - macOS 11.0 or later (Intel)
          - MPV installed: brew install mpv
          
          TROUBLESHOOTING
          ---------------
          If "Radio TUI can't be opened":
          Right-click the app and select "Open"
          EOF
          
          # Create the DMG
          hdiutil create \
            -volname "Radio TUI (Intel)" \
            -srcfolder dist/dmg-contents \
            -ov \
            -format UDZO \
            dist/Radio-TUI-macOS-Intel.dmg
      
      - uses: actions/upload-artifact@v4
        with:
          name: radio-tui-macos-intel-complete
          path: dist/Radio-TUI-macOS-Intel.dmg

  # ============================================================================
  # MACOS APPLE SILICON BUILD (arm64)
  # ============================================================================
  build-vibra-macos-arm:
    runs-on: macos-14  # Apple Silicon runner
    steps:
      - uses: actions/checkout@v4
        with:
          repository: BayernMuller/vibra
          ref: main
      
      - name: Install dependencies
        run: brew install cmake fftw pkg-config
      
      - name: Build vibra for Apple Silicon
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64
          cmake --build build --config Release
      
      - uses: actions/upload-artifact@v4
        with:
          name: vibra-macos-arm
          path: build/cli/vibra

  build-radio-tui-macos-arm:
    runs-on: macos-14  # Apple Silicon runner
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: |
          rustup target add aarch64-apple-darwin
          cargo build --release --target aarch64-apple-darwin
      - uses: actions/upload-artifact@v4
        with:
          name: radio-tui-macos-arm
          path: |
            target/aarch64-apple-darwin/release/radio-tui
            target/aarch64-apple-darwin/release/radio-daemon

  package-macos-arm:
    needs: [build-vibra-macos-arm, build-radio-tui-macos-arm]
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - run: mkdir -p dist/Radio\ TUI.app/Contents/MacOS dist/artifacts
      
      - uses: actions/download-artifact@v4
        with:
          name: vibra-macos-arm
          path: dist/artifacts/vibra/
      
      - uses: actions/download-artifact@v4
        with:
          name: radio-tui-macos-arm
          path: dist/artifacts/radio/
      
      - name: Setup app bundle
        run: |
          # Find and move binaries (artifacts preserve directory structure)
          find dist/artifacts -name "vibra" -type f -exec cp {} dist/Radio\ TUI.app/Contents/MacOS/ \;
          find dist/artifacts -name "radio-tui" -type f -exec cp {} dist/Radio\ TUI.app/Contents/MacOS/ \;
          find dist/artifacts -name "radio-daemon" -type f -exec cp {} dist/Radio\ TUI.app/Contents/MacOS/ \;
          
          # Make binaries executable
          chmod +x dist/Radio\ TUI.app/Contents/MacOS/*
          
          # Copy config files
          cp songs.vds.template dist/Radio\ TUI.app/Contents/MacOS/songs.vds
          cp stations.toml dist/Radio\ TUI.app/Contents/MacOS/
          
          # Create Info.plist
          cat > dist/Radio\ TUI.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>Radio TUI</string>
              <key>CFBundleDisplayName</key>
              <string>Radio TUI</string>
              <key>CFBundleIdentifier</key>
              <string>com.jamf.radio-tui</string>
              <key>CFBundleVersion</key>
              <string>1.0</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleExecutable</key>
              <string>launcher</string>
              <key>LSUIElement</key>
              <false/>
          </dict>
          </plist>
          EOF
          
          # Create FIXED launcher script
          cat > dist/Radio\ TUI.app/Contents/MacOS/launcher << 'SCRIPT'
          #!/bin/bash
          # Launcher script that opens Terminal and runs radio-tui
          
          # Get the directory where this script is located
          APP_DIR="$(cd "$(dirname "$0")" && pwd)"
          
          # Open Terminal and run radio-tui
          osascript << APPLESCRIPT
          tell application "Terminal"
              activate
              do script "cd '$APP_DIR' && ./radio-tui; exit"
          end tell
          APPLESCRIPT
          SCRIPT
          chmod +x dist/Radio\ TUI.app/Contents/MacOS/launcher
          
          # Create config.toml
          cat > dist/Radio\ TUI.app/Contents/MacOS/config.toml << 'EOF'
          # Radio TUI Configuration (macOS)
          [daemon]
          [http]
          enabled = true
          bind_address = "127.0.0.1"
          port = 8989
          [mpv]
          default_volume = 0.5
          [stations]
          stations_toml = "stations.toml"
          m3u_url = "https://raw.githubusercontent.com/ja-mf/radio-curation/refs/heads/main/jamf_radios.m3u"
          EOF
      
      - name: Create DMG with Applications shortcut
        run: |
          # Create a temporary directory for DMG contents
          mkdir -p dist/dmg-contents
          
          # Copy the app
          cp -r dist/Radio\ TUI.app dist/dmg-contents/
          
          # Create Applications folder alias
          ln -s /Applications dist/dmg-contents/Applications
          
          # Create README
          cat > dist/dmg-contents/README.txt << 'EOF'
          Radio TUI for macOS (Apple Silicon)
          =====================================
          
          INSTALLATION
          ------------
          Drag Radio TUI.app to the Applications folder
          
          USAGE
          -----
          1. Double-click Radio TUI.app (opens in Terminal)
          2. Navigate with arrow keys
          3. Enter to play, Space to pause
          4. 'r' to recognize songs
          5. 'q' to quit
          
          REQUIREMENTS
          ------------
          - macOS 11.0 or later (Apple Silicon/M1/M2/M3)
          - MPV installed: brew install mpv
          
          TROUBLESHOOTING
          ---------------
          If "Radio TUI can't be opened":
          Right-click the app and select "Open"
          EOF
          
          # Create the DMG
          hdiutil create \
            -volname "Radio TUI (Apple Silicon)" \
            -srcfolder dist/dmg-contents \
            -ov \
            -format UDZO \
            dist/Radio-TUI-macOS-AppleSilicon.dmg
      
      - uses: actions/upload-artifact@v4
        with:
          name: radio-tui-macos-arm-complete
          path: dist/Radio-TUI-macOS-AppleSilicon.dmg

  # ============================================================================
  # CREATE RELEASE
  # ============================================================================
  release:
    needs: [package-windows, package-linux, package-macos-intel, package-macos-arm]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/download-artifact@v4
      
      - uses: softprops/action-gh-release@v1
        with:
          files: |
            radio-tui-windows-complete/radio-tui-windows.zip
            radio-tui-linux-complete/radio-tui-linux.tar.gz
            radio-tui-macos-intel-complete/Radio-TUI-macOS-Intel.dmg
            radio-tui-macos-arm-complete/Radio-TUI-macOS-AppleSilicon.dmg
          body: |
            Radio TUI - Terminal Radio Player
            
            ## Downloads
            
            ### Windows
            - `radio-tui-windows.zip` - Extract and run `radio.exe`
            
            ### Linux
            - `radio-tui-linux.tar.gz` - Extract and run `./radio-tui`
            
            ### macOS
            - **Intel Macs**: `Radio-TUI-macOS-Intel.dmg` - Mount and copy to Applications
            - **Apple Silicon (M1/M2/M3)**: `Radio-TUI-macOS-AppleSilicon.dmg` - Mount and copy to Applications
            
            ## Features
            - Terminal-based radio player
            - MPV backend for audio playback
            - Vibra integration for song recognition (Windows/macOS)
            - Portable - no installation required (Windows)
            
            ## Quick Start
            1. Launch the application
            2. Navigate stations with arrow keys
            3. Enter to play, Space to pause
            4. 'r' to recognize and save songs
            5. 'q' to quit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
