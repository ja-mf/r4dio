name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-r4dio-windows:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc
      - run: cargo install cargo-xwin
      - run: cargo xwin build --release --target x86_64-pc-windows-msvc -p radio-tui --bin r4dio
      - uses: actions/upload-artifact@v4
        with:
          name: r4dio-windows
          path: target/x86_64-pc-windows-msvc/release/r4dio.exe

  build-vibra-windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          repository: BayernMuller/vibra
          ref: main
      - run: vcpkg install curl:x64-windows fftw3:x64-windows
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake"
          cmake --build build --config Release
      - uses: actions/upload-artifact@v4
        with:
          name: vibra-windows
          path: build/cli/Release/vibra.exe

  package-windows:
    needs: [build-r4dio-windows, build-vibra-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y p7zip-full jq zip
      - uses: actions/download-artifact@v4
        with:
          name: r4dio-windows
          path: dist/r4dio-windows-x86_64/
      - uses: actions/download-artifact@v4
        with:
          name: vibra-windows
          path: dist/r4dio-windows-x86_64/
      - name: Bundle mpv + ffmpeg
        run: |
          set -euo pipefail
          mkdir -p /tmp/mpv-win /tmp/ffmpeg-win
          API_JSON="$(curl -fsSL https://api.github.com/repos/shinchiro/mpv-winbuild-cmake/releases/latest)"
          MPV_URL="$(echo "$API_JSON" | jq -r '.assets[] | select(.name|test("^mpv-x86_64-.*\\.7z$")) | .browser_download_url' | head -n1)"
          FFMPEG_URL="$(echo "$API_JSON" | jq -r '.assets[] | select(.name|test("^ffmpeg-x86_64(-v3)?-git-.*\\.7z$")) | .browser_download_url' | head -n1)"
          test -n "$MPV_URL"
          test -n "$FFMPEG_URL"
          curl -fsSL "$MPV_URL" -o /tmp/mpv.7z
          curl -fsSL "$FFMPEG_URL" -o /tmp/ffmpeg.7z
          7z x /tmp/mpv.7z -o/tmp/mpv-win -y >/dev/null
          7z x /tmp/ffmpeg.7z -o/tmp/ffmpeg-win -y >/dev/null
          MPV_EXE="$(find /tmp/mpv-win -type f -name mpv.exe | head -n1)"
          FFMPEG_EXE="$(find /tmp/ffmpeg-win -type f -name ffmpeg.exe | head -n1)"
          FFPROBE_EXE="$(find /tmp/ffmpeg-win -type f -name ffprobe.exe | head -n1)"
          test -f "$MPV_EXE"
          test -f "$FFMPEG_EXE"
          test -f "$FFPROBE_EXE"
          cp "$MPV_EXE" dist/r4dio-windows-x86_64/mpv.exe
          cp "$FFMPEG_EXE" dist/r4dio-windows-x86_64/ffmpeg.exe
          cp "$FFPROBE_EXE" dist/r4dio-windows-x86_64/ffprobe.exe
          MPV_DIR="$(dirname "$MPV_EXE")"
          find "$MPV_DIR" -maxdepth 1 -type f -name '*.dll' -exec cp {} dist/r4dio-windows-x86_64/ \;
      - name: Add runtime files
        run: |
          cp stations.toml dist/r4dio-windows-x86_64/
          cp songs.vds.template dist/r4dio-windows-x86_64/songs.vds
          cat > dist/r4dio-windows-x86_64/config.toml << 'EOF'
          [http]
          enabled = true
          bind_address = "127.0.0.1"
          port = 8989
          [mpv]
          default_volume = 0.5
          [stations]
          stations_toml = "stations.toml"
          m3u_url = "https://raw.githubusercontent.com/ja-mf/radio-curation/refs/heads/main/jamf_radios.m3u"
          EOF
          cat > dist/r4dio-windows-x86_64/README.txt << 'EOF'
          r4dio (Windows x86_64)
          ---------------------
          1) Unzip this folder.
          2) Run r4dio.exe.
          3) Enter plays, Space pauses, q quits, i runs recognition.

          Bundled: mpv, ffmpeg, ffprobe, vibra, stations.toml, songs.vds
          EOF
          (cd dist && zip -r r4dio-windows-x86_64.zip r4dio-windows-x86_64 >/dev/null)
      - uses: actions/upload-artifact@v4
        with:
          name: r4dio-windows-package
          path: dist/r4dio-windows-x86_64.zip

  build-r4dio-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y libasound2-dev pkg-config
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo build --release -p radio-tui --bin r4dio
      - uses: actions/upload-artifact@v4
        with:
          name: r4dio-linux
          path: target/release/r4dio

  build-vibra-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: BayernMuller/vibra
          ref: main
      - run: sudo apt-get update && sudo apt-get install -y cmake build-essential pkg-config libcurl4-openssl-dev libfftw3-dev
      - run: cmake -B build -DCMAKE_BUILD_TYPE=Release && cmake --build build --config Release
      - uses: actions/upload-artifact@v4
        with:
          name: vibra-linux
          path: build/cli/vibra

  package-linux:
    needs: [build-r4dio-linux, build-vibra-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y jq xz-utils tar
      - uses: actions/download-artifact@v4
        with:
          name: r4dio-linux
          path: dist/r4dio-linux-x86_64/
      - uses: actions/download-artifact@v4
        with:
          name: vibra-linux
          path: dist/r4dio-linux-x86_64/
      - name: Bundle mpv + ffmpeg
        run: |
          set -euo pipefail
          mkdir -p /tmp/linux-bundle
          MPV_URL="$(curl -fsSL https://api.github.com/repos/ivan-hc/MPV-appimage/releases/latest | jq -r '.assets[] | select(.name|endswith(".AppImage")) | .browser_download_url' | head -n1)"
          FFMPEG_URL="$(curl -fsSL https://api.github.com/repos/BtbN/FFmpeg-Builds/releases/latest | jq -r '.assets[] | select(.name=="ffmpeg-master-latest-linux64-gpl.tar.xz") | .browser_download_url')"
          test -n "$MPV_URL"
          test -n "$FFMPEG_URL"
          curl -fsSL "$MPV_URL" -o dist/r4dio-linux-x86_64/mpv
          chmod +x dist/r4dio-linux-x86_64/mpv
          curl -fsSL "$FFMPEG_URL" -o /tmp/ffmpeg-linux.tar.xz
          tar -xf /tmp/ffmpeg-linux.tar.xz -C /tmp/linux-bundle
          FFMPEG_EXE="$(find /tmp/linux-bundle -type f -path '*ffmpeg-master-latest-linux64-gpl*/bin/ffmpeg' | head -n1)"
          FFPROBE_EXE="$(find /tmp/linux-bundle -type f -path '*ffmpeg-master-latest-linux64-gpl*/bin/ffprobe' | head -n1)"
          test -f "$FFMPEG_EXE"
          test -f "$FFPROBE_EXE"
          cp "$FFMPEG_EXE" dist/r4dio-linux-x86_64/ffmpeg
          cp "$FFPROBE_EXE" dist/r4dio-linux-x86_64/ffprobe
          chmod +x dist/r4dio-linux-x86_64/ffmpeg dist/r4dio-linux-x86_64/ffprobe
      - name: Add runtime files
        run: |
          chmod +x dist/r4dio-linux-x86_64/r4dio dist/r4dio-linux-x86_64/vibra
          cp stations.toml dist/r4dio-linux-x86_64/
          cp songs.vds.template dist/r4dio-linux-x86_64/songs.vds
          cat > dist/r4dio-linux-x86_64/config.toml << 'EOF'
          [http]
          enabled = true
          bind_address = "127.0.0.1"
          port = 8989
          [mpv]
          default_volume = 0.5
          [stations]
          stations_toml = "stations.toml"
          m3u_url = "https://raw.githubusercontent.com/ja-mf/radio-curation/refs/heads/main/jamf_radios.m3u"
          EOF
          cat > dist/r4dio-linux-x86_64/README.txt << 'EOF'
          r4dio (Linux x86_64)
          -------------------
          1) Extract tarball.
          2) Run ./r4dio
          3) Enter plays, Space pauses, q quits, i runs recognition.

          Bundled: mpv, ffmpeg, ffprobe, vibra, stations.toml, songs.vds
          EOF
          (cd dist && tar czf r4dio-linux-x86_64.tar.gz r4dio-linux-x86_64)
      - uses: actions/upload-artifact@v4
        with:
          name: r4dio-linux-package
          path: dist/r4dio-linux-x86_64.tar.gz

  build-r4dio-macos-intel:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin
      - run: cargo build --release --target x86_64-apple-darwin -p radio-tui --bin r4dio
      - uses: actions/upload-artifact@v4
        with:
          name: r4dio-macos-intel
          path: target/x86_64-apple-darwin/release/r4dio

  build-vibra-macos-intel:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          repository: BayernMuller/vibra
          ref: main
      - name: Install Rosetta + x86_64 dependencies
        run: |
          set -euo pipefail
          softwareupdate --install-rosetta --agree-to-license || true
          if [ ! -x /usr/local/bin/brew ]; then
            arch -x86_64 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" </dev/null
          fi
          arch -x86_64 /usr/local/bin/brew update
          arch -x86_64 /usr/local/bin/brew install cmake fftw pkg-config
      - name: Build vibra for x86_64
        run: |
          set -euo pipefail
          export PATH="/usr/local/bin:$PATH"
          export PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
          arch -x86_64 cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64 -DCMAKE_PREFIX_PATH=/usr/local
          arch -x86_64 cmake --build build --config Release
      - uses: actions/upload-artifact@v4
        with:
          name: vibra-macos-intel
          path: build/cli/vibra

  package-macos-intel:
    needs: [build-r4dio-macos-intel, build-vibra-macos-intel]
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - run: brew install jq
      - uses: actions/download-artifact@v4
        with:
          name: r4dio-macos-intel
          path: dist/r4dio-macos-x86_64/
      - uses: actions/download-artifact@v4
        with:
          name: vibra-macos-intel
          path: dist/r4dio-macos-x86_64/
      - name: Bundle mpv + ffmpeg
        run: |
          set -euo pipefail
          MPV_URL="$(curl -fsSL https://api.github.com/repos/pashynskykh/mpv-macos/releases/latest | jq -r '.assets[] | select(.name|test("x86_64\\.dmg$")) | .browser_download_url' | head -n1)"
          FFMPEG_URL="$(curl -fsSL https://api.github.com/repos/ColorsWind/FFmpeg-macOS/releases/latest | jq -r '.assets[] | select(.name|test("OSX-x86_64\\.zip$")) | .browser_download_url' | head -n1)"
          test -n "$MPV_URL"
          test -n "$FFMPEG_URL"
          curl -fsSL "$MPV_URL" -o /tmp/mpv-macos-intel.dmg
          hdiutil attach /tmp/mpv-macos-intel.dmg -nobrowse -mountpoint /tmp/mpv-mount-intel
          cp -R /tmp/mpv-mount-intel/mpv.app dist/r4dio-macos-x86_64/mpv.app
          hdiutil detach /tmp/mpv-mount-intel
          cat > dist/r4dio-macos-x86_64/mpv << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          exec "$DIR/mpv.app/Contents/MacOS/mpv" "$@"
          EOF
          chmod +x dist/r4dio-macos-x86_64/mpv
          curl -fsSL "$FFMPEG_URL" -o /tmp/ffmpeg-macos-intel.zip
          unzip -q /tmp/ffmpeg-macos-intel.zip -d /tmp/ffmpeg-macos-intel
          FF_ROOT="$(dirname "$(dirname "$(find /tmp/ffmpeg-macos-intel -type f -path '*/bin/ffmpeg' | head -n1)")")"
          test -d "$FF_ROOT"
          mkdir -p dist/r4dio-macos-x86_64/ffmpeg-dist
          cp -R "$FF_ROOT"/. dist/r4dio-macos-x86_64/ffmpeg-dist/
          cat > dist/r4dio-macos-x86_64/ffmpeg << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          export DYLD_LIBRARY_PATH="$DIR/ffmpeg-dist/lib:${DYLD_LIBRARY_PATH:-}"
          exec "$DIR/ffmpeg-dist/bin/ffmpeg" "$@"
          EOF
          cat > dist/r4dio-macos-x86_64/ffprobe << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          export DYLD_LIBRARY_PATH="$DIR/ffmpeg-dist/lib:${DYLD_LIBRARY_PATH:-}"
          exec "$DIR/ffmpeg-dist/bin/ffprobe" "$@"
          EOF
          chmod +x dist/r4dio-macos-x86_64/ffmpeg dist/r4dio-macos-x86_64/ffprobe
      - name: Add runtime files
        run: |
          chmod +x dist/r4dio-macos-x86_64/r4dio dist/r4dio-macos-x86_64/vibra
          cp stations.toml dist/r4dio-macos-x86_64/
          cp songs.vds.template dist/r4dio-macos-x86_64/songs.vds
          cat > dist/r4dio-macos-x86_64/config.toml << 'EOF'
          [http]
          enabled = true
          bind_address = "127.0.0.1"
          port = 8989
          [mpv]
          default_volume = 0.5
          [stations]
          stations_toml = "stations.toml"
          m3u_url = "https://raw.githubusercontent.com/ja-mf/radio-curation/refs/heads/main/jamf_radios.m3u"
          EOF
          cat > dist/r4dio-macos-x86_64/README.txt << 'EOF'
          r4dio (macOS x86_64)
          --------------------
          1) Unzip this folder.
          2) Run ./r4dio
          3) Enter plays, Space pauses, q quits, i runs recognition.

          Bundled: mpv.app wrapper, ffmpeg, ffprobe, vibra, stations.toml, songs.vds
          EOF
          (cd dist && zip -r r4dio-macos-x86_64.zip r4dio-macos-x86_64 >/dev/null)
      - uses: actions/upload-artifact@v4
        with:
          name: r4dio-macos-x86_64-package
          path: dist/r4dio-macos-x86_64.zip

  build-r4dio-macos-arm:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin
      - run: cargo build --release --target aarch64-apple-darwin -p radio-tui --bin r4dio
      - uses: actions/upload-artifact@v4
        with:
          name: r4dio-macos-arm
          path: target/aarch64-apple-darwin/release/r4dio

  build-vibra-macos-arm:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          repository: BayernMuller/vibra
          ref: main
      - run: brew install cmake fftw pkg-config
      - run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 && cmake --build build --config Release
      - uses: actions/upload-artifact@v4
        with:
          name: vibra-macos-arm
          path: build/cli/vibra

  package-macos-arm:
    needs: [build-r4dio-macos-arm, build-vibra-macos-arm]
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - run: brew install jq
      - uses: actions/download-artifact@v4
        with:
          name: r4dio-macos-arm
          path: dist/r4dio-macos-arm64/
      - uses: actions/download-artifact@v4
        with:
          name: vibra-macos-arm
          path: dist/r4dio-macos-arm64/
      - name: Bundle mpv + ffmpeg
        run: |
          set -euo pipefail
          MPV_URL="$(curl -fsSL https://api.github.com/repos/pashynskykh/mpv-macos/releases/latest | jq -r '.assets[] | select(.name|test("arm64\\.dmg$")) | .browser_download_url' | head -n1)"
          FFMPEG_URL="$(curl -fsSL https://api.github.com/repos/ColorsWind/FFmpeg-macOS/releases/latest | jq -r '.assets[] | select(.name|test("OSX-arm64\\.zip$")) | .browser_download_url' | head -n1)"
          test -n "$MPV_URL"
          test -n "$FFMPEG_URL"
          curl -fsSL "$MPV_URL" -o /tmp/mpv-macos-arm.dmg
          hdiutil attach /tmp/mpv-macos-arm.dmg -nobrowse -mountpoint /tmp/mpv-mount-arm
          cp -R /tmp/mpv-mount-arm/mpv.app dist/r4dio-macos-arm64/mpv.app
          hdiutil detach /tmp/mpv-mount-arm
          cat > dist/r4dio-macos-arm64/mpv << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          exec "$DIR/mpv.app/Contents/MacOS/mpv" "$@"
          EOF
          chmod +x dist/r4dio-macos-arm64/mpv
          curl -fsSL "$FFMPEG_URL" -o /tmp/ffmpeg-macos-arm.zip
          unzip -q /tmp/ffmpeg-macos-arm.zip -d /tmp/ffmpeg-macos-arm
          FF_ROOT="$(dirname "$(dirname "$(find /tmp/ffmpeg-macos-arm -type f -path '*/bin/ffmpeg' | head -n1)")")"
          test -d "$FF_ROOT"
          mkdir -p dist/r4dio-macos-arm64/ffmpeg-dist
          cp -R "$FF_ROOT"/. dist/r4dio-macos-arm64/ffmpeg-dist/
          cat > dist/r4dio-macos-arm64/ffmpeg << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          export DYLD_LIBRARY_PATH="$DIR/ffmpeg-dist/lib:${DYLD_LIBRARY_PATH:-}"
          exec "$DIR/ffmpeg-dist/bin/ffmpeg" "$@"
          EOF
          cat > dist/r4dio-macos-arm64/ffprobe << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          export DYLD_LIBRARY_PATH="$DIR/ffmpeg-dist/lib:${DYLD_LIBRARY_PATH:-}"
          exec "$DIR/ffmpeg-dist/bin/ffprobe" "$@"
          EOF
          chmod +x dist/r4dio-macos-arm64/ffmpeg dist/r4dio-macos-arm64/ffprobe
      - name: Add runtime files
        run: |
          chmod +x dist/r4dio-macos-arm64/r4dio dist/r4dio-macos-arm64/vibra
          cp stations.toml dist/r4dio-macos-arm64/
          cp songs.vds.template dist/r4dio-macos-arm64/songs.vds
          cat > dist/r4dio-macos-arm64/config.toml << 'EOF'
          [http]
          enabled = true
          bind_address = "127.0.0.1"
          port = 8989
          [mpv]
          default_volume = 0.5
          [stations]
          stations_toml = "stations.toml"
          m3u_url = "https://raw.githubusercontent.com/ja-mf/radio-curation/refs/heads/main/jamf_radios.m3u"
          EOF
          cat > dist/r4dio-macos-arm64/README.txt << 'EOF'
          r4dio (macOS arm64)
          -------------------
          1) Unzip this folder.
          2) Run ./r4dio
          3) Enter plays, Space pauses, q quits, i runs recognition.

          Bundled: mpv.app wrapper, ffmpeg, ffprobe, vibra, stations.toml, songs.vds
          EOF
          (cd dist && zip -r r4dio-macos-arm64.zip r4dio-macos-arm64 >/dev/null)
      - uses: actions/upload-artifact@v4
        with:
          name: r4dio-macos-arm64-package
          path: dist/r4dio-macos-arm64.zip

  release:
    needs:
      - package-windows
      - package-linux
      - package-macos-intel
      - package-macos-arm
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/download-artifact@v4
      - uses: softprops/action-gh-release@v1
        with:
          files: |
            r4dio-windows-package/r4dio-windows-x86_64.zip
            r4dio-linux-package/r4dio-linux-x86_64.tar.gz
            r4dio-macos-x86_64-package/r4dio-macos-x86_64.zip
            r4dio-macos-arm64-package/r4dio-macos-arm64.zip
          body: |
            r4dio v1.0

            Downloads:
            - Windows: r4dio-windows-x86_64.zip
            - Linux: r4dio-linux-x86_64.tar.gz
            - macOS Intel: r4dio-macos-x86_64.zip
            - macOS Apple Silicon: r4dio-macos-arm64.zip

            Each archive includes:
            - r4dio
            - mpv
            - ffmpeg + ffprobe
            - vibra
            - stations.toml (current repo version)
            - songs.vds (empty template)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
