name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-r4dio-windows:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc
      - run: cargo install cargo-xwin
      - run: cargo xwin build --release --target x86_64-pc-windows-msvc -p radio-tui --bin r4dio
      - uses: actions/upload-artifact@v4
        with:
          name: r4dio-windows
          path: target/x86_64-pc-windows-msvc/release/r4dio.exe

  build-vibra-windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          repository: BayernMuller/vibra
          ref: main
      - run: vcpkg install curl:x64-windows-static fftw3:x64-windows-static
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows-static `
            -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded
          cmake --build build --config Release
      - uses: actions/upload-artifact@v4
        with:
          name: vibra-windows
          path: build/cli/Release/vibra.exe

  package-windows:
    needs: [build-r4dio-windows, build-vibra-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y p7zip-full jq zip
      - uses: actions/download-artifact@v4
        with:
          name: r4dio-windows
          path: dist/r4dio-windows-x86_64/
      - uses: actions/download-artifact@v4
        with:
          name: vibra-windows
          path: dist/r4dio-windows-x86_64/
      - name: Bundle mpv + ffmpeg + ffprobe + yt-dlp
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          DIST=dist/r4dio-windows-x86_64
          mkdir -p /tmp/mpv-win /tmp/ffmpeg-win "$DIST/external" "$DIST/data"
          # gh api handles public-repo auth correctly; avoids cross-repo token issues
          MPV_URL="$(gh api repos/shinchiro/mpv-winbuild-cmake/releases/latest \
            --jq '.assets[] | select(.name | test("^mpv-x86_64-[0-9].*\\.7z$")) | .browser_download_url' \
            | head -1)"
          FFMPEG_URL="$(gh api repos/shinchiro/mpv-winbuild-cmake/releases/latest \
            --jq '.assets[] | select(.name | test("^ffmpeg-x86_64-git-.*\\.7z$")) | .browser_download_url' \
            | head -1)"
          echo "MPV_URL: $MPV_URL"
          echo "FFMPEG_URL: $FFMPEG_URL"
          test -n "$MPV_URL"
          test -n "$FFMPEG_URL"
          curl -fsSL "$MPV_URL" -o /tmp/mpv.7z
          curl -fsSL "$FFMPEG_URL" -o /tmp/ffmpeg.7z
          7z x /tmp/mpv.7z -o/tmp/mpv-win -y
          7z x /tmp/ffmpeg.7z -o/tmp/ffmpeg-win -y
          MPV_EXE="$(find /tmp/mpv-win -type f -name mpv.exe | head -n1)"
          FFMPEG_EXE="$(find /tmp/ffmpeg-win /tmp/mpv-win -type f -name ffmpeg.exe | head -n1)"
          echo "MPV_EXE: $MPV_EXE"
          echo "FFMPEG_EXE: $FFMPEG_EXE"
          test -f "$MPV_EXE"
          test -f "$FFMPEG_EXE"
          # All executables go in external/
          cp "$MPV_EXE" "$DIST/external/mpv.exe"
          cp "$FFMPEG_EXE" "$DIST/external/ffmpeg.exe"
          # Download ffprobe from ffmpeg-static (fully static, no dependencies)
          echo "Downloading ffprobe from ffmpeg-static..."
          curl -fsSL "https://github.com/eugeneware/ffmpeg-static/releases/download/b6.1.1/ffprobe-win32-x64.gz" | gunzip > "$DIST/external/ffprobe.exe"
          chmod +x "$DIST/external/ffprobe.exe"
          echo "ffprobe.exe downloaded successfully"
          # Download yt-dlp
          echo "Downloading yt-dlp..."
          curl -fsSL "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe" -o "$DIST/external/yt-dlp.exe"
          chmod +x "$DIST/external/yt-dlp.exe"
          echo "yt-dlp.exe downloaded successfully"
          # vibra.exe was downloaded to dist root by actions/download-artifact — move it
          mv "$DIST/vibra.exe" "$DIST/external/vibra.exe"
          # mpv's DLLs must live beside mpv.exe so Windows finds them when mpv.exe runs
          MPV_DIR="$(dirname "$MPV_EXE")"
          find "$MPV_DIR" -maxdepth 1 -type f -name '*.dll' -exec cp {} "$DIST/external/" \;
      - name: Add runtime files
        run: |
          DIST=dist/r4dio-windows-x86_64
          cp stations.toml "$DIST/data/"
          cp starred.toml "$DIST/data/"
          cp songs.vds.template "$DIST/data/songs.vds"
          cp LICENSE "$DIST/LICENSE.txt"
          cat > "$DIST/config.toml" << 'EOF'
          [http]
          enabled = true
          bind_address = "127.0.0.1"
          port = 8989
          [mpv]
          default_volume = 0.5
          [stations]
          stations_toml = "data/stations.toml"
          m3u_url = "https://raw.githubusercontent.com/ja-mf/radio-curation/refs/heads/main/jamf_radios.m3u"
          EOF
          cat > "$DIST/README.txt" << 'EOF'
          r4dio (Windows x86_64)
          ---------------------
          1) Unzip this folder.
          2) Run r4dio.exe.
          3) Space pauses, q quits, i identifies the current song, d downloads NTS shows.

          Folder layout:
            r4dio.exe       — main app
            config.toml     — configuration
            data/           — stations.toml, starred.toml, songs.vds
            external/       — mpv, ffmpeg, ffprobe, yt-dlp, vibra + supporting DLLs
          EOF
          (cd dist && zip -r r4dio-windows-x86_64.zip r4dio-windows-x86_64 >/dev/null)
      - uses: actions/upload-artifact@v4
        with:
          name: r4dio-windows-package
          path: dist/r4dio-windows-x86_64.zip

  build-r4dio-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y libasound2-dev pkg-config
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo build --release -p radio-tui --bin r4dio
      - uses: actions/upload-artifact@v4
        with:
          name: r4dio-linux
          path: target/release/r4dio

  build-vibra-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: BayernMuller/vibra
          ref: main
      - run: sudo apt-get update && sudo apt-get install -y cmake build-essential pkg-config libcurl4-openssl-dev libfftw3-dev
      - run: cmake -B build -DCMAKE_BUILD_TYPE=Release && cmake --build build --config Release
      - uses: actions/upload-artifact@v4
        with:
          name: vibra-linux
          path: build/cli/vibra

  package-linux:
    needs: [build-r4dio-linux, build-vibra-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y jq xz-utils tar
      - uses: actions/download-artifact@v4
        with:
          name: r4dio-linux
          path: dist/r4dio-linux-x86_64/
      - uses: actions/download-artifact@v4
        with:
          name: vibra-linux
          path: dist/r4dio-linux-x86_64/
      - name: Bundle mpv + ffmpeg + yt-dlp
        run: |
          set -euo pipefail
          mkdir -p /tmp/linux-bundle
          MPV_URL="$(curl -fsSL https://api.github.com/repos/ivan-hc/MPV-appimage/releases/latest | jq -r '.assets[] | select(.name|endswith(".AppImage")) | .browser_download_url' | head -n1)"
          FFMPEG_URL="$(curl -fsSL https://api.github.com/repos/BtbN/FFmpeg-Builds/releases/latest | jq -r '.assets[] | select(.name=="ffmpeg-master-latest-linux64-gpl.tar.xz") | .browser_download_url')"
          test -n "$MPV_URL"
          test -n "$FFMPEG_URL"
          curl -fsSL "$MPV_URL" -o dist/r4dio-linux-x86_64/mpv
          chmod +x dist/r4dio-linux-x86_64/mpv
          curl -fsSL "$FFMPEG_URL" -o /tmp/ffmpeg-linux.tar.xz
          tar -xf /tmp/ffmpeg-linux.tar.xz -C /tmp/linux-bundle
          FFMPEG_EXE="$(find /tmp/linux-bundle -type f -path '*ffmpeg-master-latest-linux64-gpl*/bin/ffmpeg' | head -n1)"
          FFPROBE_EXE="$(find /tmp/linux-bundle -type f -path '*ffmpeg-master-latest-linux64-gpl*/bin/ffprobe' | head -n1)"
          test -f "$FFMPEG_EXE"
          test -f "$FFPROBE_EXE"
          cp "$FFMPEG_EXE" dist/r4dio-linux-x86_64/ffmpeg
          cp "$FFPROBE_EXE" dist/r4dio-linux-x86_64/ffprobe
          chmod +x dist/r4dio-linux-x86_64/ffmpeg dist/r4dio-linux-x86_64/ffprobe
          # Download yt-dlp
          echo "Downloading yt-dlp..."
          curl -fsSL "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp" -o dist/r4dio-linux-x86_64/yt-dlp
          chmod +x dist/r4dio-linux-x86_64/yt-dlp
          echo "yt-dlp downloaded successfully"
      - name: Add runtime files
        run: |
          chmod +x dist/r4dio-linux-x86_64/r4dio dist/r4dio-linux-x86_64/vibra
          cp stations.toml dist/r4dio-linux-x86_64/
          cp starred.toml dist/r4dio-linux-x86_64/
          cp songs.vds.template dist/r4dio-linux-x86_64/songs.vds
          cp LICENSE dist/r4dio-linux-x86_64/LICENSE
          cat > dist/r4dio-linux-x86_64/config.toml << 'EOF'
          [http]
          enabled = true
          bind_address = "127.0.0.1"
          port = 8989
          [mpv]
          default_volume = 0.5
          [stations]
          stations_toml = "stations.toml"
          m3u_url = "https://raw.githubusercontent.com/ja-mf/radio-curation/refs/heads/main/jamf_radios.m3u"
          EOF
          cat > dist/r4dio-linux-x86_64/README.txt << 'EOF'
          r4dio (Linux x86_64)
          -------------------
          1) Extract tarball.
          2) Run ./r4dio
          3) Enter plays, Space pauses, q quits, i runs recognition, d downloads NTS shows.

          Bundled: mpv, ffmpeg, ffprobe, yt-dlp, vibra, stations.toml, songs.vds
          EOF
          (cd dist && tar czf r4dio-linux-x86_64.tar.gz r4dio-linux-x86_64)
      - uses: actions/upload-artifact@v4
        with:
          name: r4dio-linux-package
          path: dist/r4dio-linux-x86_64.tar.gz

  build-r4dio-macos-intel:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin
      - run: cargo build --release --target x86_64-apple-darwin -p radio-tui --bin r4dio
      - uses: actions/upload-artifact@v4
        with:
          name: r4dio-macos-intel
          path: target/x86_64-apple-darwin/release/r4dio

  build-vibra-macos-intel:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          repository: BayernMuller/vibra
          ref: main
      - name: Install Rosetta + x86_64 dependencies
        run: |
          set -euo pipefail
          softwareupdate --install-rosetta --agree-to-license || true
          if [ ! -x /usr/local/bin/brew ]; then
            arch -x86_64 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" </dev/null
          fi
          arch -x86_64 /usr/local/bin/brew update
          arch -x86_64 /usr/local/bin/brew install cmake fftw pkg-config
      - name: Build vibra for x86_64
        run: |
          set -euo pipefail
          export PATH="/usr/local/bin:$PATH"
          export PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
          arch -x86_64 cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64 -DCMAKE_PREFIX_PATH=/usr/local
          arch -x86_64 cmake --build build --config Release
      - uses: actions/upload-artifact@v4
        with:
          name: vibra-macos-intel
          path: build/cli/vibra

  package-macos-intel:
    needs: [build-r4dio-macos-intel, build-vibra-macos-intel]
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - run: brew install jq
      - uses: actions/download-artifact@v4
        with:
          name: r4dio-macos-intel
          path: dist/r4dio-macos-x86_64/
      - uses: actions/download-artifact@v4
        with:
          name: vibra-macos-intel
          path: dist/r4dio-macos-x86_64/
      - name: Bundle mpv + ffmpeg
        run: |
          set -euo pipefail
          MPV_URL="$(curl -fsSL https://api.github.com/repos/pashynskykh/mpv-macos/releases/latest | jq -r '.assets[] | select(.name|test("x86_64\\.dmg$")) | .browser_download_url' | head -n1)"
          FFMPEG_URL="$(curl -fsSL https://api.github.com/repos/ColorsWind/FFmpeg-macOS/releases/latest | jq -r '.assets[] | select(.name|test("OSX-x86_64\\.zip$")) | .browser_download_url' | head -n1)"
          test -n "$MPV_URL"
          test -n "$FFMPEG_URL"
          curl -fsSL "$MPV_URL" -o /tmp/mpv-macos-intel.dmg
          hdiutil attach /tmp/mpv-macos-intel.dmg -nobrowse -mountpoint /tmp/mpv-mount-intel
          cp -R /tmp/mpv-mount-intel/mpv.app dist/r4dio-macos-x86_64/mpv.app
          hdiutil detach /tmp/mpv-mount-intel
          cat > dist/r4dio-macos-x86_64/mpv << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          exec "$DIR/mpv.app/Contents/MacOS/mpv" "$@"
          EOF
          chmod +x dist/r4dio-macos-x86_64/mpv
          curl -fsSL "$FFMPEG_URL" -o /tmp/ffmpeg-macos-intel.zip
          unzip -q /tmp/ffmpeg-macos-intel.zip -d /tmp/ffmpeg-macos-intel
          FF_ROOT="$(dirname "$(dirname "$(find /tmp/ffmpeg-macos-intel -type f -path '*/bin/ffmpeg' | head -n1)")")"
          test -d "$FF_ROOT"
          mkdir -p dist/r4dio-macos-x86_64/ffmpeg-dist
          cp -R "$FF_ROOT"/. dist/r4dio-macos-x86_64/ffmpeg-dist/
          cat > dist/r4dio-macos-x86_64/ffmpeg << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          export DYLD_LIBRARY_PATH="$DIR/ffmpeg-dist/lib:${DYLD_LIBRARY_PATH:-}"
          exec "$DIR/ffmpeg-dist/bin/ffmpeg" "$@"
          EOF
          cat > dist/r4dio-macos-x86_64/ffprobe << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          export DYLD_LIBRARY_PATH="$DIR/ffmpeg-dist/lib:${DYLD_LIBRARY_PATH:-}"
          exec "$DIR/ffmpeg-dist/bin/ffprobe" "$@"
          EOF
          chmod +x dist/r4dio-macos-x86_64/ffmpeg dist/r4dio-macos-x86_64/ffprobe
          # Download yt-dlp for macOS x86_64
          echo "Downloading yt-dlp for macOS x86_64..."
          curl -fsSL "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp_macos_legacy" -o dist/r4dio-macos-x86_64/yt-dlp
          chmod +x dist/r4dio-macos-x86_64/yt-dlp
          echo "yt-dlp downloaded successfully"
      - name: Add runtime files
        run: |
          set -euo pipefail
          DIST="dist/r4dio-macos-x86_64"
          BUNDLE="$DIST/r4dio.app/Contents/MacOS"
          mkdir -p "$BUNDLE"
          # Info.plist
          cat > "$DIST/r4dio.app/Contents/Info.plist" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key><string>r4dio</string>
            <key>CFBundleIdentifier</key><string>com.ja-mf.r4dio</string>
            <key>CFBundleName</key><string>r4dio</string>
            <key>CFBundlePackageType</key><string>APPL</string>
            <key>CFBundleShortVersionString</key><string>1.1</string>
            <key>CFBundleVersion</key><string>2</string>
            <key>LSMinimumSystemVersion</key><string>10.14</string>
            <key>NSHighResolutionCapable</key><true/>
          </dict>
          </plist>
          PLIST
          # Move binary into bundle as r4dio-bin; launcher script as r4dio
          mv "$DIST/r4dio" "$BUNDLE/r4dio-bin"
          chmod +x "$BUNDLE/r4dio-bin"
          cat > "$BUNDLE/r4dio" << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          export PATH="$DIR:$PATH"
          if [ -t 0 ]; then
            exec "$DIR/r4dio-bin" "$@"
          else
            osascript -e "tell application \"Terminal\" to activate" \
                      -e "tell application \"Terminal\" to do script \"'$DIR/r4dio-bin'\""
          fi
          EOF
          chmod +x "$BUNDLE/r4dio"
          # Move support binaries into bundle
          mv "$DIST/vibra" "$BUNDLE/vibra" && chmod +x "$BUNDLE/vibra"
          mv "$DIST/mpv.app" "$BUNDLE/mpv.app"
          cat > "$BUNDLE/mpv" << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          exec "$DIR/mpv.app/Contents/MacOS/mpv" "$@"
          EOF
          chmod +x "$BUNDLE/mpv"
          mv "$DIST/ffmpeg-dist" "$BUNDLE/ffmpeg-dist"
          cat > "$BUNDLE/ffmpeg" << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          export DYLD_LIBRARY_PATH="$DIR/ffmpeg-dist/lib:${DYLD_LIBRARY_PATH:-}"
          exec "$DIR/ffmpeg-dist/bin/ffmpeg" "$@"
          EOF
          cat > "$BUNDLE/ffprobe" << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          export DYLD_LIBRARY_PATH="$DIR/ffmpeg-dist/lib:${DYLD_LIBRARY_PATH:-}"
          exec "$DIR/ffmpeg-dist/bin/ffprobe" "$@"
          EOF
          chmod +x "$BUNDLE/ffmpeg" "$BUNDLE/ffprobe"
          # Move yt-dlp into bundle
          mv "$DIST/yt-dlp" "$BUNDLE/yt-dlp" && chmod +x "$BUNDLE/yt-dlp"
          # Remove stale wrapper scripts from dist root (now inside bundle)
          rm -f "$DIST/mpv" "$DIST/ffmpeg" "$DIST/ffprobe"
          # Runtime files inside bundle
          cp stations.toml "$BUNDLE/stations.toml"
          cp starred.toml "$BUNDLE/starred.toml"
          cp songs.vds.template "$BUNDLE/songs.vds"
          cp LICENSE "$BUNDLE/LICENSE"
          # Create DMG with Applications symlink for drag-to-install
          mkdir -p /tmp/dmg-staging-intel
          cp -R "$DIST/r4dio.app" /tmp/dmg-staging-intel/
          ln -s /Applications /tmp/dmg-staging-intel/Applications
          hdiutil create -volname "r4dio" \
            -srcfolder /tmp/dmg-staging-intel \
            -ov -format UDZO \
            dist/r4dio-macos-x86_64.dmg
      - uses: actions/upload-artifact@v4
        with:
          name: r4dio-macos-x86_64-package
          path: dist/r4dio-macos-x86_64.dmg

  build-r4dio-macos-arm:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin
      - run: cargo build --release --target aarch64-apple-darwin -p radio-tui --bin r4dio
      - uses: actions/upload-artifact@v4
        with:
          name: r4dio-macos-arm
          path: target/aarch64-apple-darwin/release/r4dio

  build-vibra-macos-arm:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          repository: BayernMuller/vibra
          ref: main
      - run: brew install cmake fftw pkg-config
      - run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 && cmake --build build --config Release
      - uses: actions/upload-artifact@v4
        with:
          name: vibra-macos-arm
          path: build/cli/vibra

  package-macos-arm:
    needs: [build-r4dio-macos-arm, build-vibra-macos-arm]
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - run: brew install jq
      - uses: actions/download-artifact@v4
        with:
          name: r4dio-macos-arm
          path: dist/r4dio-macos-arm64/
      - uses: actions/download-artifact@v4
        with:
          name: vibra-macos-arm
          path: dist/r4dio-macos-arm64/
      - name: Bundle mpv + ffmpeg
        run: |
          set -euo pipefail
          MPV_URL="$(curl -fsSL https://api.github.com/repos/pashynskykh/mpv-macos/releases/latest | jq -r '.assets[] | select(.name|test("arm64\\.dmg$")) | .browser_download_url' | head -n1)"
          FFMPEG_URL="$(curl -fsSL https://api.github.com/repos/ColorsWind/FFmpeg-macOS/releases/latest | jq -r '.assets[] | select(.name|test("OSX-arm64\\.zip$")) | .browser_download_url' | head -n1)"
          test -n "$MPV_URL"
          test -n "$FFMPEG_URL"
          curl -fsSL "$MPV_URL" -o /tmp/mpv-macos-arm.dmg
          hdiutil attach /tmp/mpv-macos-arm.dmg -nobrowse -mountpoint /tmp/mpv-mount-arm
          cp -R /tmp/mpv-mount-arm/mpv.app dist/r4dio-macos-arm64/mpv.app
          hdiutil detach /tmp/mpv-mount-arm
          cat > dist/r4dio-macos-arm64/mpv << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          exec "$DIR/mpv.app/Contents/MacOS/mpv" "$@"
          EOF
          chmod +x dist/r4dio-macos-arm64/mpv
          curl -fsSL "$FFMPEG_URL" -o /tmp/ffmpeg-macos-arm.zip
          unzip -q /tmp/ffmpeg-macos-arm.zip -d /tmp/ffmpeg-macos-arm
          FF_ROOT="$(dirname "$(dirname "$(find /tmp/ffmpeg-macos-arm -type f -path '*/bin/ffmpeg' | head -n1)")")"
          test -d "$FF_ROOT"
          mkdir -p dist/r4dio-macos-arm64/ffmpeg-dist
          cp -R "$FF_ROOT"/. dist/r4dio-macos-arm64/ffmpeg-dist/
          cat > dist/r4dio-macos-arm64/ffmpeg << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          export DYLD_LIBRARY_PATH="$DIR/ffmpeg-dist/lib:${DYLD_LIBRARY_PATH:-}"
          exec "$DIR/ffmpeg-dist/bin/ffmpeg" "$@"
          EOF
          cat > dist/r4dio-macos-arm64/ffprobe << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          export DYLD_LIBRARY_PATH="$DIR/ffmpeg-dist/lib:${DYLD_LIBRARY_PATH:-}"
          exec "$DIR/ffmpeg-dist/bin/ffprobe" "$@"
          EOF
          chmod +x dist/r4dio-macos-arm64/ffmpeg dist/r4dio-macos-arm64/ffprobe
          # Download yt-dlp for macOS ARM64
          echo "Downloading yt-dlp for macOS ARM64..."
          curl -fsSL "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp_macos" -o dist/r4dio-macos-arm64/yt-dlp
          chmod +x dist/r4dio-macos-arm64/yt-dlp
          echo "yt-dlp downloaded successfully"
      - name: Add runtime files
        run: |
          set -euo pipefail
          DIST="dist/r4dio-macos-arm64"
          BUNDLE="$DIST/r4dio.app/Contents/MacOS"
          mkdir -p "$BUNDLE"
          # Info.plist
          cat > "$DIST/r4dio.app/Contents/Info.plist" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key><string>r4dio</string>
            <key>CFBundleIdentifier</key><string>com.ja-mf.r4dio</string>
            <key>CFBundleName</key><string>r4dio</string>
            <key>CFBundlePackageType</key><string>APPL</string>
            <key>CFBundleShortVersionString</key><string>1.0</string>
            <key>CFBundleVersion</key><string>1</string>
            <key>LSMinimumSystemVersion</key><string>10.14</string>
            <key>NSHighResolutionCapable</key><true/>
          </dict>
          </plist>
          PLIST
          # Move binary into bundle as r4dio-bin; launcher script as r4dio
          mv "$DIST/r4dio" "$BUNDLE/r4dio-bin"
          chmod +x "$BUNDLE/r4dio-bin"
          cat > "$BUNDLE/r4dio" << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          export PATH="$DIR:$PATH"
          if [ -t 0 ]; then
            exec "$DIR/r4dio-bin" "$@"
          else
            osascript -e "tell application \"Terminal\" to activate" \
                      -e "tell application \"Terminal\" to do script \"'$DIR/r4dio-bin'\""
          fi
          EOF
          chmod +x "$BUNDLE/r4dio"
          # Move support binaries into bundle
          mv "$DIST/vibra" "$BUNDLE/vibra" && chmod +x "$BUNDLE/vibra"
          mv "$DIST/mpv.app" "$BUNDLE/mpv.app"
          cat > "$BUNDLE/mpv" << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          exec "$DIR/mpv.app/Contents/MacOS/mpv" "$@"
          EOF
          chmod +x "$BUNDLE/mpv"
          mv "$DIST/ffmpeg-dist" "$BUNDLE/ffmpeg-dist"
          cat > "$BUNDLE/ffmpeg" << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          export DYLD_LIBRARY_PATH="$DIR/ffmpeg-dist/lib:${DYLD_LIBRARY_PATH:-}"
          exec "$DIR/ffmpeg-dist/bin/ffmpeg" "$@"
          EOF
          cat > "$BUNDLE/ffprobe" << 'EOF'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          export DYLD_LIBRARY_PATH="$DIR/ffmpeg-dist/lib:${DYLD_LIBRARY_PATH:-}"
          exec "$DIR/ffmpeg-dist/bin/ffprobe" "$@"
          EOF
          chmod +x "$BUNDLE/ffmpeg" "$BUNDLE/ffprobe"
          # Move yt-dlp into bundle
          mv "$DIST/yt-dlp" "$BUNDLE/yt-dlp" && chmod +x "$BUNDLE/yt-dlp"
          # Remove stale wrapper scripts from dist root (now inside bundle)
          rm -f "$DIST/mpv" "$DIST/ffmpeg" "$DIST/ffprobe"
          # Runtime files inside bundle
          cp stations.toml "$BUNDLE/stations.toml"
          cp starred.toml "$BUNDLE/starred.toml"
          cp songs.vds.template "$BUNDLE/songs.vds"
          cp LICENSE "$BUNDLE/LICENSE"
          # Create DMG with Applications symlink for drag-to-install
          mkdir -p /tmp/dmg-staging-arm
          cp -R "$DIST/r4dio.app" /tmp/dmg-staging-arm/
          ln -s /Applications /tmp/dmg-staging-arm/Applications
          hdiutil create -volname "r4dio" \
            -srcfolder /tmp/dmg-staging-arm \
            -ov -format UDZO \
            dist/r4dio-macos-arm64.dmg
      - uses: actions/upload-artifact@v4
        with:
          name: r4dio-macos-arm64-package
          path: dist/r4dio-macos-arm64.dmg

  release:
    needs:
      - package-windows
      - package-linux
      - package-macos-intel
      - package-macos-arm
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
      - name: Build changelog
        id: changelog
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | grep -v "^${{ github.ref_name }}$" | head -1)
          if [ -n "$PREV_TAG" ]; then
            LOG=$(git log --oneline "$PREV_TAG"..HEAD --no-merges)
          else
            LOG=$(git log --oneline HEAD --no-merges)
          fi
          echo "log<<EOF" >> $GITHUB_OUTPUT
          echo "$LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - uses: softprops/action-gh-release@v1
        with:
          files: |
            r4dio-windows-package/r4dio-windows-x86_64.zip
            r4dio-linux-package/r4dio-linux-x86_64.tar.gz
            r4dio-macos-x86_64-package/r4dio-macos-x86_64.dmg
            r4dio-macos-arm64-package/r4dio-macos-arm64.dmg
          body: |
            **Windows**: unzip `r4dio-windows-x86_64.zip`, run `r4dio.exe`. Binaries in `external/`, data files in `data/`.
            **macOS**: open DMG, drag `r4dio` to Applications. First launch: right-click → Open to bypass Gatekeeper.
            **Linux**: `tar xzf r4dio-linux-x86_64.tar.gz && cd r4dio-linux-x86_64 && ./r4dio`

            Space = pause · n/p = next/prev · i = identify song · q = quit

            ## Changes
            ${{ steps.changelog.outputs.log }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
