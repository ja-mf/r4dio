name: Build Windows Release

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  MPV_VERSION: "20260207"
  MPV_COMMIT: "git-9ccd889"
  FFMPEG_COMMIT: "git-c352a9ab0"

jobs:
  # Build Vibra audio fingerprinting tool
  build-vibra:
    runs-on: windows-2022
    steps:
      - name: Checkout vibra repository
        uses: actions/checkout@v4
        with:
          repository: BayernMuller/vibra
          ref: main

      - name: Install dependencies
        run: vcpkg install curl:x64-windows fftw3:x64-windows

      - name: Build vibra
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake"
          cmake --build build --config Release

      - name: Upload vibra artifact
        uses: actions/upload-artifact@v4
        with:
          name: vibra-cli
          path: build/cli/Release/*.exe

  # Build Radio TUI
  build-radio-tui:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ja-mf/r4dio
          ref: main

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install cargo-xwin
        run: cargo install cargo-xwin

      - name: Build Windows binaries
        run: cargo xwin build --target x86_64-pc-windows-msvc --release

      - name: Upload radio-tui artifacts
        uses: actions/upload-artifact@v4
        with:
          name: radio-tui-binaries
          path: |
            target/x86_64-pc-windows-msvc/release/radio-tui.exe
            target/x86_64-pc-windows-msvc/release/radio-daemon.exe

  # Package everything together
  package:
    needs: [build-vibra, build-radio-tui]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ja-mf/r4dio
          ref: main

      - name: Create distribution directory
        run: mkdir -p dist/radio-tui-windows

      - name: Download vibra
        uses: actions/download-artifact@v4
        with:
          name: vibra-cli
          path: dist/radio-tui-windows/

      - name: Download radio-tui
        uses: actions/download-artifact@v4
        with:
          name: radio-tui-binaries
          path: dist/radio-tui-windows/

      - name: Download and extract MPV
        run: |
          cd dist/radio-tui-windows
          wget -q "https://github.com/shinchiro/mpv-winbuild-cmake/releases/download/${{ env.MPV_VERSION }}/mpv-x86_64-${{ env.MPV_COMMIT }}-${{ env.MPV_VERSION }}.7z" -O mpv.7z
          7z x mpv.7z -y
          rm mpv.7z
          # Move mpv.exe to root if it's in a subdirectory
          if [ -d "mpv-x86_64-${{ env.MPV_COMMIT }}-${{ env.MPV_VERSION }}" ]; then
            mv mpv-x86_64-${{ env.MPV_COMMIT }}-${{ env.MPV_VERSION }}/* .
            rmdir mpv-x86_64-${{ env.MPV_COMMIT }}-${{ env.MPV_VERSION }}
          fi

      - name: Download and extract FFmpeg
        run: |
          cd dist/radio-tui-windows
          wget -q "https://github.com/shinchiro/mpv-winbuild-cmake/releases/download/${{ env.MPV_VERSION }}/ffmpeg-x86_64-${{ env.FFMPEG_COMMIT }}-${{ env.MPV_VERSION }}.7z" -O ffmpeg.7z
          7z x ffmpeg.7z -y
          rm ffmpeg.7z

      - name: Copy configuration files
        run: |
          cp songs.vds.template dist/radio-tui-windows/songs.vds
          cp stations.toml dist/radio-tui-windows/

      - name: Create config.toml
        run: |
          cat > dist/radio-tui-windows/config.toml << 'EOF'
          # Radio TUI Configuration (Windows Portable)
          # Place this file in the same folder as radio.exe

          [daemon]
          # PID and state files will be created in %LOCALAPPDATA%\radio\

          [http]
          enabled = true
          bind_address = "127.0.0.1"
          port = 8989

          [mpv]
          default_volume = 0.5

          [stations]
          # Load stations from local stations.toml (portable mode)
          stations_toml = "stations.toml"
          m3u_url = "https://raw.githubusercontent.com/ja-mf/radio-curation/refs/heads/main/jamf_radios.m3u"
          EOF

      - name: Create README.txt
        run: |
          cat > dist/radio-tui-windows/README.txt << 'EOF'
          Radio TUI for Windows
          =======================

          A terminal-based internet radio player with audio fingerprinting.

          QUICK START
          -----------
          1. Double-click radio.exe or run: .\radio.exe
          2. Navigate with arrow keys
          3. Enter to play, Space to pause
          4. Press 'r' to recognize and save current song
          5. Press 'q' to quit

          SON RECOGNITION (VIBRA)
          -----------------------
          This build includes Vibra for audio fingerprinting:
          - Press 'r' while a song is playing
          - The app will record a sample and fingerprint it
          - Song info is saved to songs.vds with full metadata

          FILES
          -----
          - radio.exe         - Main TUI application
          - radio-daemon.exe  - Background service
          - mpv.exe           - Media player backend
          - vibra.exe         - Audio fingerprinting tool
          - ffmpeg.exe        - Media processing (for vibra)
          - stations.toml     - Station list (edit to customize)
          - config.toml       - Settings file
          - songs.vds         - Song database (your saved tracks)

          REQUIREMENTS
          ------------
          - Windows 10 or Windows 11
          - No Visual C++ Redistributable needed (statically linked)
          - No installation required - portable

          TROUBLESHOOTING
          ---------------
          If stuck on "connecting to daemon...":
          1. Ensure radio-daemon.exe is in the same folder as radio.exe
          2. Check Windows Defender isn't blocking the executable
          3. Try running from PowerShell to see error messages

          For more info: https://github.com/ja-mf/r4dio
          EOF

      - name: Create launcher script
        run: |
          cat > dist/radio-tui-windows/radio.bat << 'EOF'
          @echo off
          cd /d "%~dp0"
          echo Starting Radio TUI with Vibra...
          echo.
          "%~dp0radio.exe"
          EOF

      - name: Create ZIP archive
        run: |
          cd dist
          zip -r radio-tui-windows.zip radio-tui-windows/

      - name: Upload final package
        uses: actions/upload-artifact@v4
        with:
          name: radio-tui-windows-complete
          path: dist/radio-tui-windows.zip

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/radio-tui-windows.zip
          body: |
            Radio TUI for Windows with Vibra audio fingerprinting
            
            ### Features:
            - Terminal-based radio player
            - MPV backend for audio playback
            - Vibra integration for song recognition
            - FFmpeg for audio processing
            - Portable - no installation required
            
            ### Usage:
            1. Extract ZIP to any folder
            2. Run `radio.exe`
            3. Press 'r' while playing to recognize songs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
