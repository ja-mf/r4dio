name: Build Windows Release

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build vibra first (dependency)
  build-vibra:
    runs-on: windows-2022
    steps:
      - name: Checkout vibra repository
        uses: actions/checkout@v4
        with:
          repository: BayernMuller/vibra
          ref: main

      - name: Install dependencies
        run: vcpkg install curl:x64-windows fftw3:x64-windows

      - name: Configure CMake with vcpkg
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_SUFFIX=windows-amd64 -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake"

      - name: Build vibra
        run: cmake --build ${{ github.workspace }}/build --config Release

      - name: Upload vibra artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vibra-windows-amd64
          path: |
            build/cli/Release/*.exe
            build/lib/Release/*.dll

  # Build radio-tui for Windows
  build-radio-tui:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install cargo-xwin
        run: cargo install cargo-xwin

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm clang lld

      - name: Build Windows binaries
        run: cargo xwin build --target x86_64-pc-windows-msvc --release

      - name: Upload radio-tui artifacts
        uses: actions/upload-artifact@v4
        with:
          name: radio-tui-windows-binaries
          path: |
            target/x86_64-pc-windows-msvc/release/radio-tui.exe
            target/x86_64-pc-windows-msvc/release/radio-daemon.exe

  # Package everything together
  package:
    needs: [build-vibra, build-radio-tui]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download vibra artifacts
        uses: actions/download-artifact@v4
        with:
          name: vibra-windows-amd64
          path: ./vibra/

      - name: Download radio-tui artifacts
        uses: actions/download-artifact@v4
        with:
          name: radio-tui-windows-binaries
          path: ./radio-tui/

      - name: Create distribution package
        run: |
          mkdir -p dist/radio-tui-windows
          
          # Copy radio-tui binaries
          cp radio-tui/radio-tui.exe dist/radio-tui-windows/radio.exe
          cp radio-tui/radio-daemon.exe dist/radio-tui-windows/
          
          # Copy vibra CLI
          cp vibra/*.exe dist/radio-tui-windows/ 2>/dev/null || true
          cp vibra/*.dll dist/radio-tui-windows/ 2>/dev/null || true
          
          # Copy MPV and dependencies from win64 folder
          if [ -d "win64/mpv" ]; then
            cp win64/mpv/mpv.exe dist/radio-tui-windows/
            cp win64/mpv/*.dll dist/radio-tui-windows/ 2>/dev/null || true
          fi
          
          # Copy configuration files
          cp stations.toml dist/radio-tui-windows/
          cp build-windows.sh dist/radio-tui-windows/config.toml 2>/dev/null || echo "# Radio TUI Configuration" > dist/radio-tui-windows/config.toml
          
          # Create empty song database
          echo "timestamp|title|artist|album|genre|year|radio_station|show_name|url|icy_raw|fingerprint|recognized|extra" > dist/radio-tui-windows/songs.vds
          
          # Create README
          cat > dist/radio-tui-windows/README.txt << 'EOF'
Radio TUI for Windows with Vibra Song Recognition
==================================================

A terminal-based internet radio player with audio fingerprinting.

QUICK START
-----------
1. Double-click radio.exe or run: .\radio.exe
2. Navigate with arrow keys
3. Enter to play, Space to pause
4. Press 'q' to quit
5. Press 'r' to recognize and save current song

SONG RECOGNITION (VIBRA)
------------------------
This build includes Vibra for audio fingerprinting:
- Press 'r' while a song is playing
- The app will record a sample and fingerprint it
- Song info is saved to songs.vds with full metadata

FILES
-----
- radio.exe         - Main TUI application
- radio-daemon.exe  - Background service
- mpv.exe           - Media player backend
- vibra.exe         - Audio fingerprinting tool
- stations.toml     - Station list
- config.toml       - Settings file
- songs.vds         - Song database

REQUIREMENTS
------------
- Windows 10 or Windows 11
- No Visual C++ Redistributable needed
- No installation required

TROUBLESHOOTING
---------------
If stuck on "connecting to daemon...":
1. Ensure radio-daemon.exe is in the same folder as radio.exe
2. Check Windows Defender isn't blocking the executable
3. Try running from PowerShell to see error messages

For more info: https://github.com/ja-mf/radio-tui
EOF
          
          # Create launcher script
          cat > dist/radio-tui-windows/radio.bat << 'EOF'
@echo off
cd /d "%~dp0"
echo Starting Radio TUI with Vibra...
echo.
"%~dp0radio.exe"
EOF
          
          # Create ZIP
          cd dist
          zip -r radio-tui-windows-vibra.zip radio-tui-windows/
          cd ..

      - name: Upload final package
        uses: actions/upload-artifact@v4
        with:
          name: radio-tui-windows-vibra
          path: dist/radio-tui-windows-vibra.zip

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/radio-tui-windows-vibra.zip
          body: |
            Radio TUI for Windows with Vibra audio fingerprinting
            
            ### Features:
            - Terminal-based radio player
            - MPV backend for audio playback
            - Vibra integration for song recognition
            - Portable - no installation required
            
            ### Usage:
            1. Extract ZIP to any folder
            2. Run `radio.exe`
            3. Press 'r' while playing to recognize songs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
